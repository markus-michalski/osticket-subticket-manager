name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2', '8.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, json
          coverage: none

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: PHP Syntax Check
        run: |
          echo "Checking PHP syntax..."
          find . -name "*.php" ! -path "./vendor/*" ! -path "./tests/*" -print0 | while IFS= read -r -d '' file; do
            echo "Checking: $file"
            php -l "$file"
          done

      - name: Run PHPUnit Tests
        run: vendor/bin/phpunit --testdox

  package-validation:
    name: Package Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Required Files
        run: |
          echo "Verifying plugin structure..."
          test -f plugin.php || { echo "Error: plugin.php not found"; exit 1; }
          test -f config.php || { echo "Error: config.php not found"; exit 1; }
          test -f README.md || { echo "Error: README.md not found"; exit 1; }
          test -f CHANGELOG.md || { echo "Error: CHANGELOG.md not found"; exit 1; }
          test -f LICENSE || { echo "Error: LICENSE not found"; exit 1; }
          test -f composer.json || { echo "Error: composer.json not found"; exit 1; }
          test -f .releaseinclude || { echo "Error: .releaseinclude not found"; exit 1; }
          test -d ajax || { echo "Error: ajax/ directory not found"; exit 1; }
          test -d js || { echo "Error: js/ directory not found"; exit 1; }
          test -d scp-files || { echo "Error: scp-files/ directory not found"; exit 1; }
          test -d vendor || echo "Warning: vendor/ not committed (expected, will be built on install)"
          echo "✓ All required files present"

      - name: Verify CHANGELOG format
        run: |
          echo "Checking CHANGELOG.md format..."
          grep -q "## \[Unreleased\]" CHANGELOG.md || { echo "Error: [Unreleased] section missing"; exit 1; }
          echo "✓ CHANGELOG format valid"

      - name: Check plugin.php metadata
        run: |
          echo "Checking plugin.php metadata..."
          grep -q "'id'" plugin.php || { echo "Error: Plugin ID not found"; exit 1; }
          grep -q "class.SubticketPlugin.php" plugin.php || { echo "Error: Plugin class reference not found"; exit 1; }
          test -f class.SubticketPlugin.php || { echo "Error: Plugin class file not found"; exit 1; }
          echo "✓ Plugin metadata valid"
